# 1. 주소 변환(Address Mapping)

**호스트나 라우터로 패킷을 전달하기 위해서는 논리 및 물리 주소가 모두 필요하다**

> 논리 주소를 물리 주소로 변환하는 것과, 그 반대의 변환도 필요하다.
- 이 변환들은 정적 또는 동적으로 가능
> 

## 1.1 정적 변환

**정적 변환에서는 논리 주소와 물리 주소를 연관시키는 `테이블`을 사용한다**

- 이 테이블은 네트워크 상의 각 기계 내에 저장(라우터 내에 저장)
- 다른 기계의 IP 주소를 알고있는데 물리 주소를 모르는 경우 이 테이블을 들여다 보면 된다.
- 정적 테이블은 주기적으로 갱신되어야 한다
    - 기계의 NIC를 바꿀 수 있음
    - 이동 컴퓨터가 하나의 물리적 네트워크에서 다른 네트워크로 이동 가능

## 1.2 동적 변환

한 기계가 다른 기계의 논리 주소를 알고 있을 때, 프로토콜을 사용하여 물리 주소 또는 논리 주소를 찾을 수 있다.

**동적 변환을 위한 두 개의 프로토콜**

1. ARP : IP → MAC
2. RARP : MAC → IP

![](https://velog.velcdn.com/images/alstjr971/post/5b573f4f-f90f-483c-949e-2bf134ef330a/image.png)

---

# 2. ARP 프로토콜

![](https://velog.velcdn.com/images/alstjr971/post/9e012708-5279-4fb0-822a-0bf1fd38d443/image.png)

**어떤 호스트나 라우터가 다른 호스트나 라우터에게 보낼 IP 데이터그램을 가지고 있을 때, 송신자는 수신자의 IP 주소를 알고 있다.**

그러나 IP 데이터그램은 물리적 네트워크를 통과하기 위해 `프레임` 내에 `캡슐화` 되어야 한다.

> 즉, 송신자는 수신자의 물리 주소를 알아야 한다.
**- 2계층을 지나가려면 MAC 주소를 알아야 함**
> 

**💡ARP는 IP 프로토콜로부터 IP 주소를 받아서, 이를 해당 IP의 MAC 주소로 변환한 후, 데이터 링크 계층에 전달하는 프로토콜이다.**

## 2.1 ARP 동작

![](https://velog.velcdn.com/images/alstjr971/post/37ff1947-ec10-45ac-b320-30521cfbc03e/image.png)

1. 왼쪽에 있는 시스템 A는 IP 주소로 141.23.56.23을 가진 다른 시스템 B에게 패킷을 보내려고 함

2. 시스템 A는 실제 전달을 위해, 이 패킷을 데이터링크 계층에 보내야 한다.
  - 하지만, 수신자의 물리 주소를 모르는 상황
  - 목적지 IP 주소만 알고 있음(DNS 서버를 통해)

3. 시스템 A는 ARP 서비스를 사용해 시스템 B의 MAC 주소를 묻는 ARP 요청 패킷을 `브로드캐스트`함

3. 위 패킷은 물리적인 네트워크 상에 있는 모든 시스템이 수신하지만, 오직 시스템 B만 응답(나머지는 폐기함)

4. 시스템 B는 자신의 물리 주소를 포함하는 ARP 응답 해킷을 보냄

5. 이제 시스템 A는 B로 가는 모든 패킷을 수신된 물리 주소를 사용해 전송

![](https://velog.velcdn.com/images/alstjr971/post/8bde8f9d-8247-44f9-b3d7-46c475475626/image.png)

![](https://velog.velcdn.com/images/alstjr971/post/c4e29f6b-24f8-4376-897d-fe1a5ce6dc02/image.png)

![](https://velog.velcdn.com/images/alstjr971/post/14fa648d-82ed-4934-931a-f5504304f8f7/image.png)

---

# 3. 프록시 ARP
**프록시 ARP 기술은 `서브넷팅 효과`를 만들기 위해 사용된다.**

- 프록시 ARP는 호스트 집합을 대신하여 수행하는 ARP
- 프록시 ARP를 수행하는 라우터가 이 집합 중 한 호스트의 물리 주소를 찾는 ARP 요청을 받으면, 그 라우터는 자신의 물리 주소를 ARP 응답 메시지를 통해 알림

후에 라우터가 실제 IP 패킷을 받으면, 이 패킷을 적절한 호스트나 라우터에게 전송하는 방식으로 동작한다.

![](https://velog.velcdn.com/images/alstjr971/post/79458a86-692f-41c6-8c89-6680ea54ec82/image.png)


---

# 4. ARP 패키지
**단순화된 ARP 소프트웨어 패키지**

> 가상의 ARP 패키지의 구성요소와 이 구성요소들 사이의 관계를 살펴봄으로써 ARP 동작 구조를 자세히 이해해보자.

![](https://velog.velcdn.com/images/alstjr971/post/b12861bc-87fc-49a4-bf34-14977f7b6f7c/image.png)

**💡ARP 패키지는 5개의 구성요소로 구성된다.🔥**

### 4.1 캐시 테이블 - MAC 주소 캐싱

- 송신자는 일반적으로 목적지에 한 개 이상의 IP 데이터그램을 보낸다.
- 같은 호스트나 라우터를 향한 각 데이터그램을 위해 매번 ARP 프로토콜을 사용하는 것은 매우 비효율적이다.

> 이렇게 여러 개의 패킷마다 ARP 요청을 하는 비효율을 해결하기 위해 캐시 테이블을 사용한다.
- 캐시 테이블에 저장된 주소는 다음 몇 분 동안 같은 수신자로 보내지는 데이터그램을 위해 사용 가능하다.
- ARP 프로토콜을 지나가긴 하지만, 캐시 테이블에서 바로 뽑아서 시간 최적화

**`캐시 테이블의 필드`**

1. 상태 : FREE, PENDING, RESOLVED
2. 하드웨어 유형 : ARP 패킷의 해당 필드와 동일
3. 프로토콜 유형 : ARP 패킷의 해당 필드와 동일 
4. 하드웨어 길이 : ARP 패킷의 해당 필드와 동일
5. 프로토콜 길이 : ARP 패킷의 해당 필드와 동일
6. 인터페이스 번호 : NIC 이름
7. 큐 번호 : 주소 변환을 기다리는 패킷들을 번호로 표시된 큐에 삽입
8. 시도 : 이 엔트리를 위해 ARP 요청을 보낸 횟수
9. 타임아웃 : 엔트리 수명
10. 하드웨어 주소 : 목적지 하드웨어 주소
11. 프로토콜 주소 : 목적지 IP 주소

### 4.2 큐 - ARP 패킷 대기 공간

**ARP가 물리 주소를 얻으려고 하는 동안, IP 패킷을 저장하기 위하여 큐를 사용한다.**

출력 모듈이 해결되지 않은 패킷을 해당 큐로 전송한다.

입력 모듈은 큐에서 패킷을 가져와 해결된 물리 주소와 함께 데이터링크 계층에 전송한다.

### 4.3 출력 모듈 - 내보내기

1. Sleep until an IP packet is received from IP software.
2. Check cache table for an entry corresponding to the destination of IP packet
3. If (entry is found)
3.1 If (the state is RESOLVED)
3.1.1 Extract the value of the hardware address from the entry
3.1.2 Send the packet and the hardware address to data link layer
3.1.3 Return
3.2 If (the state is PENDING)
3.2.1 Enqueue the packet to the corresponding queue
3.2.2 Return
4. If (entry is not found)
4.1 Create a cache with state set to PENDING and “Attempts” set to 1
4.2 Create a queue
4.3 Enqueue the packet
4.4 Send an ARP request
5. Return

### 4.4 입력 모듈 - 받기

1. Sleep until an ARP packet (request or reply) arrives
2. Check the cache table to find the corresponding entry
3. If (found)
3.1 Update the entry
3.2 If (the state is PENDING)
3.2.1 While the queue is not empty
3.2.1.1 Dequeue one packet
3.2.1.2 Send the packet and the hardware address to data link
4. If (not found)
4.1 Create an entry
4.2 Add the entry to the table
5. If (the packet is a request)
5.1 Send an ARP reply
6. Return


### 4.5 캐시 제어 모듈 - LRU, 캐시 테이블 관리

1. Sleep until the periodic timer matures
2. Repeat for every entry in the cache table
2.1 If (the state is FREE) Continue
2.2 If (the state is PENDING)
2.2.1 Increment the value of “Attempts” by 1
2.2.2 If (“Attempts” greater than “Maximum”)
2.2.2.1 Change the state to FREE
2.2.2.2 Destroy the corresponding queue
2.2.3 Else
2.2.3.1 Send an ARP request
2.2.4 Continue
2.3 If (the state is RESOLVED)
2.3.1 Decrement the value of time-out
2.3.2 If (time-out less than or equal to zero)
2.3.2.1 Change the state to FREE
2.3.2.2 Destroy the corresponding queue 

![](https://velog.velcdn.com/images/alstjr971/post/f007f691-0004-4791-830e-401b39644bab/image.png)
